"use strict";hui.define("hui_action",["hui_template","hui_control"],function(){hui.BaseModel=function(t){hui.EventDispatcher.call(this);var e={};this.set=function(t,i){var n,o,i,r=[],u=Object.prototype.toString.call(t);if("[object Object]"!==u&&"[object String]"!==u||"[object Object]"===u&&void 0!==i)return this.trigger("SET_ERROR",t,i);"[object String]"==u?(o={},o[t]=i):o=t;for(n in o)Object.prototype.hasOwnProperty.call(e,n)?"undefined"!=typeof JSON&&JSON.stringify(e[n])!=JSON.stringify(o[n])?(r.push([n,hui.BaseModel.clone(e[n]),hui.BaseModel.clone(o[n])]),e[n]=o[n]):e[n]!==o[n]&&(r.push([n,hui.BaseModel.clone(e[n]),hui.BaseModel.clone(o[n])]),e[n]=o[n]):(r.push([n,void 0,hui.BaseModel.clone(o[n])]),e[n]=i);for(var a=0,c=r.length;c>a;a++)this.trigger("change:"+r[a][0],r[a][1],r[a][2]);r.length&&this.trigger("change")},this.get=function(t){return hui.BaseModel.clone(e[t])},this.getData=function(){return hui.BaseModel.clone(e)},this.remove=function(t){var i=e[t];return this.set(t,void 0),delete e[t],i},this.dispose=function(){this._listeners=void 0,e=void 0};var i=e,n=t;for(var o in n)n.hasOwnProperty(o)&&(i[o]=n[o])},hui.inherits(hui.BaseModel,hui.EventDispatcher),hui.BaseModel.clone=function(t,e,i){if("undefined"==typeof t)return void 0;if("undefined"!=typeof JSON)return JSON.parse(JSON.stringify(t));var n,o,r,u,a=t,c=-1;if(e=e||[],i=i||[],t instanceof Date)a=new Date(t.getTime());else if(t instanceof Array||"[object Object]"==Object.prototype.toString.call(t)){for(r=0,u=e.length;u>r;r++)if(e[r]==t){c=r;break}if(-1!=c)a=i[c],c=-1;else if(t instanceof Array){a=[],e.push(t),i.push(a);var h=0;for(n=0,o=t.length;o>n;n++)a[h++]=hui.util.clone(t[n],e,i)}else if(t&&"[object Object]"==Object.prototype.toString.call(t)){a={},e.push(t),i.push(a);for(n in t)t.hasOwnProperty(n)&&(a[n]=hui.util.clone(t[n],e,i))}}return a},hui.Flow=function(){this.que=[],this.id=Math.random()},hui.Flow.prototype.push=function(t,e){var i=this,n=e?hui.fn(t,e):t,o=hui.fn(i.next,i);return t=function(){n(o)},i.que.push(t),i},hui.Flow.prototype.next=function(t){if(t&&t(),this.que.length>0){var e=this.que.shift();e()}},hui.Action=function(t){if(this.baseConstructed)return this;hui.Action.superClass.call(this,t,"pending"),this.main=null,this.view=null,this.PARAM_MAP={};var e=hui.Action.getExtClass("hui.BaseModel");this.model=new e,this.controlMap=[],this.type="action",this.baseConstructed=!0,hui.Control.appendControl(hui.Action,this)},hui.Action.prototype={getView:function(){var t=null===this.view?this.id:this.view;return"function"==typeof t&&(t=t()),t=hui.Action.getExtClass("hui.Template").getTarget(String(t))},enterControl:function(t){var e,i=this;e=new hui.Flow,e.push(function(e){var i=this;hui.Action.getExtClass("hui.Master").ready=!1,i.active=!0;var n,o=i,r=document.getElementById(hui.Action.MAIN_ID);if(n=(o.getMain?o.getMain():null)||(o.createMain?o.createMain():hui.Control.prototype.createMain.call(o)),n&&r&&document.getElementById(hui.Action.MAIN_ID).appendChild(n),!n)return hui.Control.error("Action's main element is invalid");if(n.setAttribute("control",o.getId?o.getId():o.id),i.args=t,!i.model){var u=hui.Action.getExtClass("hui.BaseModel");i.model=new u}for(var a in i.PARAM_MAP)a&&i.model.set(a,i.PARAM_MAP[a]);e&&e()},i),e.push(i.initModel,i),e.push(i.initView,i),e.push(function(t){var e,i,n=this;n.main&&(i=n.getView(),e=hui.Action.getExtClass("hui.Template").merge(i,n.model.getData()),n.setInnerHTML(n,e)),n.render(),n.rendered="true",hui.Action.getExtClass("hui.Control").init(n.getMain(),n.model,n),n.initBehavior(),hui.Action.getExtClass("hui.Master").checkNewRequest(),t&&t()},i),e.next()},initModel:function(t){t&&t()},getByFormName:function(t){return hui.Control.getByFormName(t,this)},onsubmitfinished:function(){},dispose:function(){var t=this;t.leave(),hui.Control.prototype.dispose.call(t),t.model&&t.model.dispose&&(t.model.dispose(),t.model=void 0),t.active=null,t.clear()},back:function(){hui.Action.getExtClass("hui.Master").back()},leave:function(){}},hui.inherits(hui.Action,hui.Control),hui.Action.derive=function(t){var e,i,n,o=function(){},r=Object.prototype.toString.call(t);if("[object Function]"==r)hui.inherits(t,hui.Action),hui.inherits(o,t),n=new o,hui.Action.call(n),t.call(n);else if("[object Object]"==r||"[object String]"==r){t="[object String]"==r?hui.window[t]:t,e=new hui.Action;for(i in e)void 0===t[i]&&(t[i]=e[i]);hui.Action.controlMap.push(t)}},hui.Action.MAIN_ID="main",hui.Action.controlMap=[],hui.Action.get=function(t){for(var e,i,n,o=hui.Action.controlMap,r=0,u=o.length;u>r;r++)i=o[r],void 0!==t&&i&&void 0!==i.id&&String(i.id)===String(t)&&(e=o[r]),i&&i.active&&(n=o[r]);return void 0!==t?e:n},hui.Action.getByActionName=function(t){var e,i,n=hui.Action.controlMap,o=null;if(t)if(i="[object Function]"===Object.prototype.toString.call(t)?t:hui[t]||hui.Action.getObjectByName(t),i&&"[object Function]"===Object.prototype.toString.call(i))for(var r=0,u=n.length;u>r;r++)e=n[r],e instanceof i&&e.constructor===i&&(o=n[r]);else for(var r=0,u=n.length;u>r;r++)e=n[r],e===t&&(o=n[r]);return o},hui.Action.removeActionIndex=function(t){for(var e,i=hui.Action.controlMap,e=0,n=i.length;n>e;e++)i[e]===t&&(i[e]=void 0)},hui.Action.makeGUID=function(){var t=1;return function(e){return"_"+(e?e:"inner")+"_"+t++}}(),hui.Action.getObjectByName=function(t,e){for(var i,n=t.split("."),o=e||hui.window;o&&(i=n.shift());)o=o[i];return o},hui.Action.getExtClass=function(t){var e=function(){};switch(t){case"hui.Control":"undefined"!=typeof hui&&hui&&hui.Control?e=hui.Control:(e.get=new Function,e.init=new Function,e.prototype.validate=new Function,e.prototype.getParamMap=new Function,e.prototype.validateAndSubmit=new Function);break;case"hui.Template":"undefined"!=typeof hui&&hui&&hui.Template?e=hui.Template:(e.getTarget=new Function,e.merge=new Function);break;case"hui.Mask":"undefined"!=typeof hui&&hui&&hui.Mask?e=hui.Mask:e.hideLoading=new Function;break;case"hui.Master":"undefined"!=typeof hui&&hui&&hui.Master?e=hui.Master:(e.checkNewRequest=new Function,e.back=new Function);break;case"hui.BaseModel":"undefined"!=typeof hui&&hui&&hui.BaseModel?e=hui.BaseModel:e.prototype.set=new Function}return e},hui.Router={pathRules:[],findAction:function(t){var e,i,n,o,r=this,u=r.pathRules,a=null;for(e=0,i=u.length;i>e;e++)o=u[e].location,o&&o instanceof RegExp&&null!==(n=o.exec(t))&&(a=u[e].action);for(e=0,i=u.length;i>e;e++)o=u[e].location,o&&"string"==typeof o&&o==t&&(a=u[e].action);return!a&&hui.window.console&&hui.window.console.error&&hui.window.console.error("Route '%s' is not defined. Please use hui.Router.setRule('%s', 'xxx');",t,t),a},setRule:function(t,e){this.pathRules.push({location:t,action:e})},init:function(){},error:function(t){if(t="error: "+t,!hui.window.console)throw Error(t);hui.window.console.log(t)}},hui.Master={historyList:[],newRequest:null,ready:!0,checkNewRequest:function(){var t=this,e=t.newRequest;t.ready=!0,e&&(t.newRequest=null,t.forward(e))},forward:function(t){var e=this;e.forwardCallback(t)},forwardCallback:function(t){var e,i,n,o=this,r=null;o.ready===!1&&(o.newRequest=t),o.ready===!0&&(e=o.parseLocator(t),i=e.location,n=e.query,o.historyList[o.historyList.length-1]&&o.disposeAction(o.parseLocator(o.historyList[o.historyList.length-1]).location),r=o.getActionInstance(o.findActionName(i)),r&&r.enterControl&&(o.historyList.push(t),r.enterControl(n)))},back:function(){var t,e,i=this;i.historyList.length>1?(t=i.parseLocator(i.historyList.pop()),e=t.location,i.disposeAction(e),i.ready=!0,i.getExtClass("hui.Locator").redirect(i.historyList.pop())):(t=i.parseLocator(i.historyList[i.historyList.length-1]),e=t.location,e=i.disposeAction(e),e&&i.getExtClass("hui.Locator").redirect(e))},findActionName:function(t,e){var i=this,n=i.getExtClass("hui.Router").findAction(t),o=n?i.getActionConstructor(n):null;return o||("nolog"!==e&&hui.window.console&&hui.window.console.error&&hui.window.console.error("hui.Router.setRule('%s', '%s'); Action '%s' is not exist.",t,n,n),"/404"!==t&&(n=i.findActionName("/404"))),n},disposeAction:function(t){var e=this,i=e.getExtClass("hui.Action").getByActionName(e.findActionName(t,"nolog")),n=i&&i.BACK_LOCATION?i.BACK_LOCATION:null;return i&&i.dispose&&i.dispose(),n},getActionConstructor:function(t){return hui[t]?t=hui[t]:"string"==typeof t&&(t=hui.Action.getObjectByName(t)),t},getActionInstance:function(t){var e=this.getActionConstructor(t);return e instanceof Function&&(e=this.getExtClass("hui.Action").getByActionName(e)||new e),e},parseLocator:function(t){t=null===t||void 0===t?window.location.href:String(t);var e,i,n,o,r={},u="",a="",c=t.split("#");if(~t.indexOf("?")){e=c[0].match(/^([^\?]*)(\?(.*))?$/),e&&(a=(4==e.length?e[3]:"")||""),i=a?a.split("&"):[];for(var h=0,s=i.length;s>h;h++)n=i[h].split("="),n.push(""),r[n[0]]=n[1]}if(~t.indexOf("#")||1===c.length){o=1===c.length?c[0]:c[1],e=o.match(/^([^~]*)(~(.*))?$/),e&&(u=e[1],a=(4==e.length?e[3]:"")||""),i=a?a.split("&"):[];for(var h=0,s=i.length;s>h;h++)n=i[h].split("="),n.push(""),r[n[0]]=n[1]}return{location:u,query:r}},init:function(){},getExtClass:function(t){var e=function(){};switch(t){case"hui.Mask":"undefined"!=typeof hui&&hui&&hui.Mask?e=hui.Mask:(e.showLoading=new Function,e.hideLoading=new Function);break;case"hui.Locator":"undefined"!=typeof hui&&hui&&hui.Locator?e=hui.Locator:e.redirect=new Function;break;case"hui.Action":"undefined"!=typeof hui&&hui&&hui.Action?e=hui.Action:e.getByActionName=new Function;break;case"hui.Router":"undefined"!=typeof hui&&hui&&hui.Router?e=hui.Router:e.findAction=new Function}return e}},hui.Locator={DEFAULT_INDEX:"/",currentLocation:null,CONTROL_IFRAME_ID:"ERHistroyRecordIframe"+String(Math.random()).replace(".",""),IFRAME_CONTENT:'<html><head></head><body><input type="text" id="save"><script type="text/javascript">var loc = "#{0}";document.getElementById("save").value = loc;parent.hui.Locator.updateLocation(loc);parent.hui.Locator.switchToLocation(loc);</script ></body></html>',getLocation:function(){var t;return(/firefox\/(\d+\.\d+)/i.test(navigator.userAgent)?+RegExp.$1:void 0)?(t=location.href.match(/#(.*)$/),t&&(t=t[1])):t=location.hash,t?t.replace(/^#/,""):""},updateLocation:function(t){var e=this,i=e.currentLocation!=t;return e.currentLocation!=t&&e.getLocation()!=t&&(location.hash=t),e.currentLocation=t,i},redirect:function(t,e){var i,n=hui.Locator,o=e||{},r=document.getElementById("histotry");if(hui.Locator.hisList||(hui.Locator.hisList=[]),i=hui.Locator.hisList,i.push(t),r&&(r.innerHTML=i.join("<br/>")),"string"==typeof t){t=t.replace(/^#/,""),0===t.length&&(t=n.DEFAULT_INDEX);var u=n.updateLocation(t);(u||o.enforce)&&(t=n.currentLocation,n.onredirect(t),u===!1?hui.Locator.switchToLocation(t):n.doRoute(t))}},doRoute:function(t){var e=this,i=e.authorize(t);if(i)return void e.redirect(i);var n=/msie (\d+\.\d+)/i.test(navigator.userAgent)?document.documentMode||+RegExp.$1:void 0;n&&8>n?e.ieRoute(t):e.switchToLocation(t)},switchToLocation:function(t){var e,i=this,n=t;hui.Router&&hui.Router.findAction&&(hui.Master&&hui.Master.parseLocator&&(n=hui.Master.parseLocator(t),n=n?n.location:t),e=hui.Router.findAction(n),t=e?t:"/404"),hui.Locator.checkRouter?hui.Locator.checkRouter(t,hui.fn(i.callMasterForward,i)):i.callMasterForward(t)},callMasterForward:function(t){"undefined"!=typeof hui&&hui.Master&&hui.Master.forward&&hui.Master.forward(t)},onredirect:new Function,reload:function(){var t=this;t.currentLocation&&t.redirect(t.currentLocation,{enforce:!0})},ieRoute:function(t){var e=this,i=document.getElementById(e.CONTROL_IFRAME_ID),n=i.contentWindow.document;n.open("text/html"),n.write(e.IFRAME_CONTENT.replace("#{0}",String(t).replace(/\\/g,"\\\\").replace(/\"/g,'\\"'))),n.close()},init:function(){var t=this,e=/msie (\d+\.\d+)/i.test(navigator.userAgent)?document.documentMode||+RegExp.$1:void 0;e&&8>e?(t.ieCreateIframeRecorder(),window.setInterval(function(){t.changeListener()},100)):"onhashchange"in window?(window.onhashchange=function(e){t.changeListener(e)},t.changeListener()):window.setInterval(function(){t.changeListener()},100)},changeListener:function(){var t=this,e=t.getLocation();e||t.currentLocation?e&&t.updateLocation(e)&&t.doRoute(e):t.redirect(t.DEFAULT_INDEX)},ieCreateIframeRecorder:function(){var t=this,e=document.createElement("iframe"),i=200,n="-1000px";e.id=t.CONTROL_IFRAME_ID,e.width=i,e.height=i,e.src="about:blank",e.style.position="absolute",e.style.top=n,e.style.left=n,document.documentElement.appendChild(e)},authorizers:[],addAuthorizer:function(t){var e=this;"function"==typeof t&&e.authorizers.push(t)},authorize:function(t){var e,i,n=this,o=n.authorizers.length;for(i=0;o>i;i++)if(e=n.authorizers[i](t))return e}},hui.Action.start=function(){var t=new hui.Flow;hui.beforeinit&&t.push(hui.beforeinit),hui.Template&&hui.Template.loadAllTemplate&&hui.Template.TEMPLATE_LIST&&t.push(function(t){hui.Template.onload=t,hui.Template.loadAllTemplate()}),t.push(hui.Template.finishLoad),hui.Action.afterStart&&t.push(hui.Action.afterStart),t.next()},hui.Action.afterStart=function(t){t()},hui.Template.finishLoad=function(t){t&&t(),hui.Template&&(hui.Template.loadedCount=-1e5,delete hui.Template.loadedCount),hui.Router&&hui.Router.init&&hui.Router.init(),hui.Locator&&hui.Locator.init&&hui.Locator.init()};var t;t=function(){hui.Action.call(this),this.id="page404";var t=hui.Action.getExtClass("hui.BaseModel");this.model=new t},t.prototype={getView:function(){var t=hui.Control.format('<div style="font-size:10pt;line-height:1.2em; line-height: 1.2em;padding: 15px;text-align: left;"><h3 style="margin:0px;line-height:3em;">The page cannot be found</h3><p>The page you are looking for might have been removed, had its name changed, or is temporarily unavailable.</p><p>Please try the following:</p><ul><li>If you typed the page address in the Address bar, make sure that it is spelled correctly.<br/></li><li>Open the <a href="#/">home page</a>, and then look for links to the information you want.</li><li>Click the <a href="javascript:history.go(-1)">Back</a> button to try another link. </li></ul><p><br></p>HTTP 404 - File not found<br />Need any help? Please contact the Monsieur #{name}.<br /></div>',this.args);return t},initModel:function(t){t&&t()},render:function(){},initBehavior:function(){}},hui.inherits(t,hui.Action),hui.Router.setRule("/404","page404"),hui.window.page404=t});